(function(){this.Modal=function(){this.closeButton=null;this.modal=null;this.overlay=null;this.transitionEnd=transitionSelect();var defaults={autoOpen:false,className:'fade-and-drop',content:"",maxWidth:270,minWidth:264,overlay:true};if(arguments[0]&&typeof arguments[0]==="object"){this.options=extendDefaults(defaults,arguments[0])}if(this.options.autoOpen===true)this.open()};Modal.prototype.close=function(){stopListenForTX();var _=this;this.modal.className=this.modal.className.replace(" paybutton-open","");this.overlay.className=this.overlay.className.replace(" paybutton-open","");this.modal.addEventListener(this.transitionEnd,function(){_.modal.parentNode.removeChild(_.modal)});this.overlay.addEventListener(this.transitionEnd,function(){if(_.overlay.parentNode)_.overlay.parentNode.removeChild(_.overlay)})};Modal.prototype.open=function(){buildOut.call(this);initializeEvents.call(this);window.getComputedStyle(this.modal).height;this.modal.className=this.modal.className+(this.modal.offsetHeight>window.innerHeight?" paybutton-open paybutton-anchored":" paybutton-open");this.overlay.className=this.overlay.className+" paybutton-open"};function buildOut(){var content,contentHolder,docFrag;if(typeof this.options.content==="string"){content=this.options.content}else{content=this.options.content.innerHTML}docFrag=document.createDocumentFragment();this.modal=document.createElement("div");this.modal.className="paybutton-modal "+this.options.className;if(this.options.overlay===true){this.overlay=document.createElement("div");this.overlay.className="paybutton-overlay "+this.options.className;docFrag.appendChild(this.overlay)}contentHolder=document.createElement("div");contentHolder.className="paybutton-content";contentHolder.id="modal-content";contentHolder.innerHTML=content;this.modal.appendChild(contentHolder);docFrag.appendChild(this.modal);document.body.appendChild(docFrag)}function extendDefaults(source,properties){var property;for(property in properties){if(properties.hasOwnProperty(property)){source[property]=properties[property]}}return source}function initializeEvents(){if(this.closeButton){this.closeButton.addEventListener('click',this.close.bind(this))}if(this.overlay){this.overlay.addEventListener('click',this.close.bind(this))}document.getElementById("bch-open").addEventListener("click",function(){this.innerHTML=("<span>Opening Bitcoin Cash Wallet</span>")})}function transitionSelect(){var el=document.createElement("div");if(el.style.WebkitTransition)return"webkitTransitionEnd";if(el.style.OTransition)return"oTransitionEnd";return'transitionend'}}());function copyBCHURI(that){var inp=document.createElement('input');inp.value=that;document.body.appendChild(inp);inp.select();document.execCommand('copy',false);inp.remove();document.getElementById("copyDiv").innerHTML=("<span>Address Copied!</span>")}function playAudio(){var successAudio=new Audio('https://paybutton.cash/pre-release/v0.1/audio/pbding.mp3');successAudio.volume=0.02;successAudio.play()}function getRandomSat(){return(Math.random()*(0.00000123-0.00000010)+0.00000010).toFixed(8)}var txListen;function startListenForTX(pbAttr){pbAttr.timeStamp=Math.floor(Date.now()/1000);txListen=setInterval(function(){listenForTX(pbAttr)},1400)}function stopListenForTX(){clearInterval(txListen)}function txDialogue(pbAttr){playAudio();if(!pbAttr.successMsg){pbAttr.successMsg="Transaction Successful!"}var successDisplay=document.getElementById("modal-content");successDisplay.innerHTML='<div>'+'<div>'+'<div class="txdialoguediv">'+'<div><span>'+pbAttr.successMsg+'</span></div>'+'</div>'+'<div class="txdialoguediv">'+'<div><span>View: </span><a href="https://explorer.bitcoin.com/bch/tx/'+pbAttr.txid+'" target="_blank" style="color: orangeRed; text-decoration: none;">Transaction</a></div>'+'</div>'+'</div>'+'</div>';console.log("Confirmed. Transaction ID:",pbAttr.txid);var paywallFieldExists=document.getElementsByClassName(pbAttr.paywallField);if(paywallFieldExists){for(var i=0;i<paywallFieldExists.length;i++){var paywallFields=paywallFieldExists[i];paywallFields.style.display="block"}}if(pbAttr.successCallback&&window[pbAttr.successCallback]){window[pbAttr.successCallback](pbAttr.txid)}}function listenForTX(pbAttr){var txRequest=new XMLHttpRequest();txRequest.open('GET','https://rest.bitcoin.com/v2/address/unconfirmed/'+pbAttr.toAddress,true);txRequest.onload=function(){if(txRequest.readyState==4&&txRequest.status==200){console.log("listening for transaction..");var txData=JSON.parse(txRequest.responseText);for(var i=0;i<txData.utxos.length;i++){var getTransactions=txData.utxos[i];if(pbAttr.timeStamp<getTransactions.ts){if(getTransactions.amount==pbAttr.bchAmount){stopListenForTX();pbAttr.txid=getTransactions.txid;txDialogue(pbAttr);return}}}}else{console.log("Found Server But There Is An Error")}};txRequest.onerror=function(){console.log("Could Not Connect To Server")};txRequest.send()}function sendToBadger(toAddress,bchAmount,successMsg,paywallField,successCallback){bchAmount=bchAmount*100000000;if(typeof web4bch!=="undefined"){web4bch=new Web4Bch(web4bch.currentProvider);if(!web4bch.bch.defaultAccount){document.getElementById("badger-open").innerHTML=("<span>Please Unlock Badger Wallet</span>");alert("Please unlock Badger Wallet before continuing.")}else{document.getElementById("badger-open").innerHTML=("<span>Opening Badger Wallet</span>");var txParams={to:toAddress,from:web4bch.bch.defaultAccount,value:bchAmount};web4bch.bch.sendTransaction(txParams,(err,res)=>{if(err){document.getElementById("badger-open").innerHTML=("<span>Send With Badger Wallet</span>")}else{stopListenForTX();pbAttr.txid=res;txDialogue(pbAttr)}})}}else{document.getElementById("badger-open").innerHTML=("<span>Badger Wallet Not Found</span>");window.open('https://badger.bitcoin.com');alert("To use Badger Wallet for this transaction, Please visit:\n\nhttps://badger.bitcoin.com for installation instructions.")}}function openModal(pbAttr){if(pbAttr.anyAmount){pbAttr.amountMessage="Send any amount of Bitcoin Cash";pbAttr.URI=pbAttr.toAddress}else{pbAttr.URI=pbAttr.toAddress+"?amount="+pbAttr.bchAmount;startListenForTX(pbAttr)}var qrParams={ecclevel:"Q",fillcolor:"#FFFFFF",textcolor:"#000000",margin:"0.5",modulesize:12};if(document.implementation.hasFeature("http://www.w3.org/2000/svg","1.1")){genQR=QRCode.generateSVG(pbAttr.URI,qrParams);var XMLS=new XMLSerializer();genQR=XMLS.serializeToString(genQR);genQR="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(genQR)));qrImage=genQR}else{genQR=QRCode.generatePNG(pbAttr.URI,qrParams);qrImage=genQR}var pbContent='<div>'+'<div>'+'<div>'+'<div class="qrparent" onclick=copyBCHURI(\''+pbAttr.URI+'\')>'+'<img class="qrcode" src="'+qrImage+'" />'+'<img class="qricon" src="https://paybutton.cash/images/bitcoincash_bare_logo.png" />'+'<div id="copyDiv" class="qrctc">Click to Copy</div>'+'</div>'+'</div>'+'<div class="dialoguediv">'+'<div><span>'+pbAttr.amountMessage+'</span></div> '+'</div>'+'<div>'+'<div><button id="bch-open" class="pay-button modal" onclick="location.href=\''+pbAttr.URI+'\'" type="button"><span>Send with BCH Wallet</span></button></div>'+'</div>'+'<div class="poweredbydiv">'+'<div><span><a href="https://paybutton.cash" target="_blank" style="color: orangeRed; text-decoration: none;">Powered by PayButton.cash</a></span></div>'+'</div>'+'</div>'+'</div>';var pbModal=new Modal({content:pbContent});pbModal.open()}function getBCHPrice(pbAttr){var fiatRequest=new XMLHttpRequest();fiatRequest.open('GET','https://index-api.bitcoin.com/api/v0/cash/price/'+pbAttr.amountType,true);fiatRequest.onload=function(){if(fiatRequest.readyState==4&&fiatRequest.status==200){var fiatData=JSON.parse(fiatRequest.responseText);if(fiatData.price!=""){var addDecimal=fiatData.price/100;var satAmount=(1/addDecimal)*pbAttr.buttonAmount;pbAttr.satAmount=satAmount.toFixed(8);pbAttr.randSat=getRandomSat();var bchAmount=Number(pbAttr.satAmount)+Number(pbAttr.randSat);pbAttr.bchAmount=bchAmount.toFixed(8);pbAttr.amountMessage=(pbAttr.buttonAmount+" "+pbAttr.amountType+" = "+pbAttr.bchAmount+" BCH");openModal(pbAttr)}else{console.log("Error Price Not Found")}}else{console.log("Found Server But There Is An Error")}};fiatRequest.onerror=function(){console.log("Could Not Connect To Server")};fiatRequest.send()}function mouseEnter(){var buttonText2=this.getAttribute("button-text-2")||"";buttonText2=buttonText2.trim();if(!buttonText2){var showAmount=this.getAttribute('amount')||"";showAmount=Number(showAmount.trim());var showType=this.getAttribute('amount-type')||"";showType=showType.trim().toUpperCase();buttonText2=showAmount+" "+showType;if(!showAmount||!showType){buttonText2="Click to send BCH"}}this.innerHTML=("<span>"+buttonText2+"</span>");if(!('ontouchend'in window))this.addEventListener('mouseleave',buttonDefaultText,false);if('ontouchend'in window)this.addEventListener('touchend',buttonDefaultText,false)}function buttonDefaultText(){var buttonText=this.getAttribute("button-text")||"";buttonText=buttonText.trim();if(!buttonText){var showAmount=this.getAttribute('amount')||"";showAmount=Number(showAmount.trim());var showType=this.getAttribute('amount-type')||"";showType=showType.trim().toUpperCase();buttonText="Send Bitcoin Cash";if(!showAmount||!showType){buttonText="Send Bitcoin Cash"}}this.innerHTML=("<span>"+buttonText+"</span>")}document.addEventListener("DOMContentLoaded",function(){var payButton=document.getElementsByClassName("pay-button");for(var i=0;i<payButton.length;i++){var payButtons=payButton[i];window.addEventListener('load',buttonDefaultText.bind(payButtons),false);if(!('ontouchstart'in window))payButtons.addEventListener('mouseenter',mouseEnter,false);if('ontouchstart'in window)payButtons.addEventListener('touchstart',mouseEnter,false);payButtons.addEventListener("click",function(pbEvent){var buttonAmount=this.getAttribute("amount")||"";buttonAmount=Number(buttonAmount.trim());var amountType=this.getAttribute("amount-type")||"";amountType=amountType.trim().toUpperCase();var toAddress=this.getAttribute("address")||"";toAddress=toAddress.trim();var successMsg=this.getAttribute("success-msg")||"";successMsg=successMsg.trim();var paywallField=this.getAttribute("paywall-field")||"";paywallField=paywallField.trim();var successCallback=this.getAttribute("success-callback")||"";successCallback=successCallback.trim();var bchAmount;var amountMessage;var anyAmount;var pbAttr={buttonAmount:buttonAmount,amountType:amountType,toAddress:toAddress,successMsg:successMsg,paywallField:paywallField,successCallback:successCallback,};if(!toAddress){alert("PayButton Error:\n\nBelow are the minimum button requirements\n\n1. address (Bitcoin Cash address)");return}if(buttonAmount||amountType){if(!buttonAmount||!amountType){alert("PayButton Error:\n\nFor specific PayButton amounts, BOTH of the following MUST be set:\n\n1. amount (Must be a number)\n2. amount-type (Can be BCH, Satoshi, USD, AUD etc)\n\nTo allow \"Any\" amount, BOTH must be blank.");return}}else{pbAttr.anyAmount=true}if(pbAttr.anyAmount){openModal(pbAttr)}else{if(amountType=="BCH"||amountType=="SATOSHI"){var satAmount=buttonAmount;if(amountType=="SATOSHI"){satAmount=satAmount/100000000}pbAttr.satAmount=satAmount.toFixed(8);pbAttr.randSat=getRandomSat();bchAmount=Number(pbAttr.satAmount)+Number(pbAttr.randSat);pbAttr.bchAmount=bchAmount.toFixed(8);pbAttr.amountMessage=("Amount = "+pbAttr.bchAmount+" BCH");openModal(pbAttr)}else{getBCHPrice(pbAttr)}}})}});var qrId='pbQR';if(!document.getElementById(qrId)){var head=document.getElementsByTagName('head')[0];var script=document.createElement('script');script.src='https://paybutton.cash/pre-release/v0.1/js/qrjs2.min.js';script.id=qrId;head.appendChild(script)}var cssButtonId='pbButtonCSS';if(!document.getElementById(cssButtonId)){var head=document.getElementsByTagName('head')[0];var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href='https://paybutton.cash/pre-release/v0.1/css/buttons.min.css';link.id=cssButtonId;link.media='all';head.appendChild(link)}var cssModalId='pbModalCSS';if(!document.getElementById(cssModalId)){var head=document.getElementsByTagName('head')[0];var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href='https://paybutton.cash/pre-release/v0.1/css/modal.min.css';link.id=cssModalId;link.media='all';head.appendChild(link)}
